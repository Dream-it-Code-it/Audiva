<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Audiva Elite — Offline Audio Scheduler</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#eaf3ff;
    --card:#ffffff;
    --ink:#003366;
    --ink-soft:#5b7aa6;
    --accent:#0b61ff;
    --accent-2:#5aa0ff;
    --muted:#f4f7ff;
    --border:#d8e6ff;
    --success:#11a66a;
    --warning:#f59e0b;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Playfair Display",system-ui,-apple-system,sans-serif}
  header{
    background: linear-gradient(135deg, var(--ink), #0a3a7a 60%, #052244);
    color:#fff; padding:16px 20px; position:sticky; top:0; z-index:5;
    box-shadow:0 10px 35px rgba(0,0,0,.15);
  }
  .hdr-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{font-weight:800; font-size:1.35rem; letter-spacing:.5px; display:flex; align-items:center; gap:.6rem}
  .brand-badge{
    width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
    background:linear-gradient(135deg,#2ea1ff,#00d1ff); color:#002244; font-weight:900
  }
  .hdr-actions{display:flex;align-items:center;gap:10px}
  .btn{
    appearance:none;border:0;border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    color:#fff; box-shadow:0 8px 24px rgba(11,97,255,.25); transition:.2s transform, .2s box-shadow;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 10px 30px rgba(11,97,255,.3)}
  .btn.secondary{background:#0d3566;color:#cfe2ff;box-shadow:none}
  .clock{font-variant-numeric:tabular-nums; font-weight:700; opacity:.9}

  main{display:grid; grid-template-columns:1.1fr .9fr; gap:18px; padding:18px; max-width:1200px; margin:0 auto}
  section{
    background:var(--card); border:1px solid var(--border);
    border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(15,60,130,.06);
  }
  h2{margin:0 0 10px; font-size:1.2rem}

  /* Upload panel */
  .uploader{display:grid; gap:14px}
  .drop{
    border:1.5px dashed #9ec2ff; border-radius:16px; background:linear-gradient(180deg,#f6f9ff, #eef5ff);
    padding:18px; display:flex; align-items:center; gap:14px; cursor:pointer;
    transition:.2s border-color, .2s background;
  }
  .drop:hover{border-color:var(--accent); background:#f4f8ff}
  .drop-ico{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
    background:linear-gradient(135deg,#77b6ff,#a8d1ff); color:#003; font-weight:900}
  .drop small{color:var(--ink-soft)}
  .hidden-input{display:none}

  /* Input rows */
  .row{display:grid; grid-template-columns:1fr 1fr auto; gap:10px}
  .field{
    position:relative; background:var(--muted); border:1px solid var(--border);
    border-radius:12px; padding:10px 12px 8px 40px;
  }
  .field input, .field select{
    width:100%; outline:2px; border:0; background:transparent; color:var(--ink); font-size:0.95rem;
  }
  .field label{
    position:absolute; top:-1px; left:12px; font-size:.72rem; color:#6d8db8; font-weight:700; letter-spacing:.02em;
  }
  .field .icon{
    position:absolute; left:12px; top:50%; transform:translateY(-2px); opacity:.6
  }
  .chipbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    background:#edf4ff; color:#0d3566; border:1px solid #cfe0ff;
    padding:6px 10px; border-radius:999px; font-size:.8rem; cursor:pointer; font-weight:600;
  }
  .chip:hover{background:#e5f0ff}

  /* Cards */
  .cards{margin-top:12px; display:grid; gap:10px}
  .card{
    border:1px solid var(--border); background:linear-gradient(180deg,#ffffff, #f8fbff);
    border-radius:14px; padding:12px; display:grid; gap:8px;
  }
  .card-head{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .title{font-weight:800}
  .meta{color:var(--ink-soft); font-size:.86rem}
  .actions{display:flex; gap:8px}
  .btn.small{padding:6px 10px; border-radius:10px; font-weight:700; font-size:.88rem}
  .btn.ghost{background:#f1f6ff; color:#0d3566; box-shadow:none}
  .btn.danger{background:linear-gradient(135deg,#ff5b73,#f43f5e)}
  .pill{
    font-weight:800; font-size:.7rem; padding:4px 8px; border-radius:999px;
    background:#eff6ff; color:#0b3a7a; border:1px solid #cfe0ff
  }

  .countdown{font-variant-numeric:tabular-nums; color:#204b86}

  /* Dashboard */
  .dash-card{border-left:6px solid #dbeafe}
  .dash-card.playing{border-left-color:var(--success)}
  .dash-card.upcoming{border-left-color:var(--warning)}
  .dash-controls{display:flex; gap:8px; margin-top:6px}

  /* Toast */
  .toast{
    position:fixed; right:18px; bottom:18px; background:#0d3566; color:#e7f0ff; padding:12px 14px;
    border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,.25); z-index:20; display:none
  }
  .toast.show{display:block}

  /* Responsive */
  @media (max-width: 980px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="hdr-row">
    <div class="brand">
      <div class="brand-badge">A</div>
      Audiva Elite — Offline Scheduler
    </div>
    <div class="hdr-actions">
      <div id="clock" class="clock">--:--:--</div>
      <button class="btn secondary" onclick="openAGI()">AGI View</button>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: Upload & Library -->
  <section>
    <h2>📥 Upload & Schedule</h2>

    <!-- Upload -->
    <div class="uploader">
      <div class="drop" id="dropZone" onclick="fileInput.click()">
        <div class="drop-ico">↑</div>
        <div>
          <div style="font-weight:800">Drag & drop your audio here</div>
          <small>or click to browse — MP3 / WAV / M4A, up to 150 MB each</small>
        </div>
        <input id="fileInput" class="hidden-input" type="file" accept="audio/*" multiple />
      </div>

      <!-- Inputs -->
      <div class="row">
        <div class="field">
          <label>Group</label>
          <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4Zm0 2c-3.33 0-6 1.34-6 3v2h12v-2c0-1.66-2.67-3-6-3Z" fill="#1e3a8a"/></svg>
          <input id="groupInput" type="text" placeholder="e.g., Morning Playlist" />
        </div>

        <div class="field">
          <label>Schedule (local time)</label>
          <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V10Zm-6 4h-4v4h2v-2h2v-2Z" fill="#1e3a8a"/></svg>
          <input id="dateInput" type="datetime-local" />
        </div>

        <div>
          <button class="btn small" onclick="scheduleUnscheduled()">Schedule</button>
        </div>
      </div>

      <!-- Quick picks -->
      <div class="chipbar">
        <span class="chip" onclick="quickAdd(1)">+1 min</span>
        <span class="chip" onclick="quickAdd(5)">+5 min</span>
        <span class="chip" onclick="quickAdd(10)">+10 min</span>
        <span class="chip" onclick="applyGroup('Default')">Default</span>
      </div>
    </div>
<br>
    <!-- Group Filter -->
    <div class="row" style="grid-template-columns:1fr 1fr">
      <div class="field">
        <label>Search</label>
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="m21 21-4.3-4.3M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="#1e3a8a" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="searchInput" type="text" placeholder="Search group or file..." oninput="filterLibrary()" />
      </div>
      <div class="field">
        <label>Group Filter</label>
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 5h18v2l-7 7v4l-4 2v-6L3 7V5Z" fill="#1e3a8a"/></svg>
        <select id="groupFilter" onchange="filterLibrary()">
          <option value="">All groups</option>
        </select>
      </div>
    </div>

    <!-- Library -->
    <div class="cards" id="library"></div>
  </section>

  <!-- RIGHT: Dashboard -->
  <section>
    <h2>📊 Now Playing & Scheduled</h2>
    <div class="cards" id="dashboard"></div>
  </section>
</main>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* ====================== CLOCK ====================== */
const clockEl = document.getElementById('clock');
setInterval(()=>{ clockEl.textContent = new Date().toLocaleTimeString(); }, 1000);

/* ====================== INDEXEDDB ====================== */
let db, items = [], activePlayers = {}; // id -> Audio
const DB_NAME="audivaDB_elite", STORE="files";
const openReq = indexedDB.open(DB_NAME, 2);
openReq.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains(STORE)){
    db.createObjectStore(STORE, { keyPath: 'id' });
  }
};
openReq.onsuccess = e => { db = e.target.result; loadAll(); };

function saveItem(item){
  const tx = db.transaction(STORE, 'readwrite');
  tx.objectStore(STORE).put(item);
}
function deleteItem(id){
  const tx = db.transaction(STORE, 'readwrite');
  tx.objectStore(STORE).delete(id);
}
function loadAll(){
  const tx = db.transaction(STORE, 'readonly');
  tx.objectStore(STORE).getAll().onsuccess = e => {
    items = e.target.result || [];
    renderEverything();
  };
}

/* ====================== UPLOAD ====================== */
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
dropZone.addEventListener('dragleave', ()=> dropZone.style.borderColor = '#9ec2ff');
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.style.borderColor = '#9ec2ff';
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', ()=> handleFiles(fileInput.files));

function handleFiles(fileList){
  [...fileList].forEach(f=>{
    if(!f.type.startsWith('audio/')){ toast('Only audio files allowed'); return; }
    if(f.size/1024/1024 > 150){ toast('File exceeds 150 MB'); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      const id = Date.now() + Math.random();
      const item = {
        id, fileName: f.name, blob: new Blob([reader.result]),
        group: '', scheduledTime: null, played:false, createdAt: Date.now()
      };
      items.push(item); saveItem(item);
      renderLibraryCard(item); refreshGroups();
      toast('File added');
    };
    reader.readAsArrayBuffer(f);
  });
}

/* ====================== QUICK ACTIONS ====================== */
const dateInput = document.getElementById('dateInput');
const groupInput = document.getElementById('groupInput');
function quickAdd(mins){
  const t = new Date(Date.now() + mins*60000);
  dateInput.value = toLocalDateTime(t);
}
function applyGroup(name){ groupInput.value = name; }
function toLocalDateTime(d){
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ====================== SCHEDULE & EDIT ====================== */
function scheduleUnscheduled(){
  const when = dateInput.value;
  const group = (groupInput.value || 'Default').trim();
  if(!when){ toast('Pick a date/time'); return; }

  let changed = 0;
  items.forEach(it=>{
    if(!it.scheduledTime){
      it.scheduledTime = when; it.group = group; it.played = false;
      saveItem(it); changed++;
    }
  });
  if(changed===0){ toast('No unscheduled files to schedule'); }
  else { toast(`Scheduled ${changed} file(s)`); }
  renderEverything();
}

function openEdit(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const newGroup = prompt('Group name:', it.group || '');
  if(newGroup===null) return;
  const newTime = prompt('Datetime (YYYY-MM-DDTHH:MM):', it.scheduledTime || toLocalDateTime(new Date()));
  if(!newTime) return;
  it.group = newGroup.trim() || 'Default';
  it.scheduledTime = newTime;
  it.played = false;
  saveItem(it);
  toast('Updated');
  renderEverything();
}

function removeItem(id){
  // stop if playing
  if(activePlayers[id]){ try{ activePlayers[id].pause(); }catch{} delete activePlayers[id]; }
  items = items.filter(x=>x.id!==id);
  deleteItem(id);
  toast('Deleted');
  renderEverything();
}

/* ====================== LIBRARY RENDER ====================== */
const library = document.getElementById('library');
const groupFilter = document.getElementById('groupFilter');
const searchInput = document.getElementById('searchInput');

function renderEverything(){
  renderLibrary();
  renderDashboard();
  refreshGroups();
}

function renderLibrary(){
  library.innerHTML = '';
  items
    .slice()
    .sort((a,b)=>b.createdAt - a.createdAt)
    .forEach(renderLibraryCard);
  filterLibrary();
}

function renderLibraryCard(it){
  const card = document.createElement('div');
  card.className = 'card';
  card.id = 'lib-' + it.id;
  card.dataset.group = (it.group||'').toLowerCase();
  card.dataset.name = (it.fileName||'').toLowerCase();

  const sch = it.scheduledTime ? new Date(it.scheduledTime) : null;

  card.innerHTML = `
    <div class="card-head">
      <div>
        <div class="title">${it.fileName}</div>
        <div class="meta">Group: <span class="pill">${it.group || '—'}</span></div>
      </div>
      <div class="actions">
        <button class="btn small ghost" onclick="openEdit(${it.id})">Edit</button>
        <button class="btn small danger" onclick="removeItem(${it.id})">Delete</button>
      </div>
    </div>
    <div class="meta">Scheduled: ${sch ? sch.toLocaleString() : 'Not set'}</div>
    <div class="countdown" id="cd-lib-${it.id}">—</div>
  `;
  library.appendChild(card);
}

function filterLibrary(){
  const q = searchInput.value.trim().toLowerCase();
  const gf = (groupFilter.value || '').toLowerCase();
  [...library.children].forEach(el=>{
    const g = el.dataset.group, n = el.dataset.name;
    const matchGroup = !gf || g===gf;
    const matchText = !q || g.includes(q) || n.includes(q);
    el.style.display = (matchGroup && matchText) ? '' : 'none';
  });
}

function refreshGroups(){
  const groups = [...new Set(items.map(i=>i.group).filter(Boolean))].sort();
  const val = groupFilter.value;
  groupFilter.innerHTML = `<option value="">All groups</option>`;
  groups.forEach(g=>{
    const opt = document.createElement('option');
    opt.value = g; opt.textContent = g;
    groupFilter.appendChild(opt);
  });
  groupFilter.value = val || '';
}

/* ====================== DASHBOARD RENDER ====================== */
const dashboard = document.getElementById('dashboard');

function renderDashboard(){
  dashboard.innerHTML='';
  const now = Date.now();
  const sorted = items.slice().sort((a,b)=>{
    const at = a.scheduledTime?new Date(a.scheduledTime).getTime():Infinity;
    const bt = b.scheduledTime?new Date(b.scheduledTime).getTime():Infinity;
    return at-bt;
  });

  sorted.forEach(it=>{
    if(!it.scheduledTime) return;
    const status = activePlayers[it.id] ? 'playing' : (it.played ? 'finished' : 'upcoming');

    const card = document.createElement('div');
    card.className = `card dash-card ${status}`;
    card.id = 'dash-' + it.id;

    card.innerHTML = `
      <div class="card-head">
        <div>
          <div class="title">${it.fileName}</div>
          <div class="meta">Group: <span class="pill">${it.group || '—'}</span></div>
        </div>
        <div class="pill" style="background:#eefbf5; color:#065f46; border-color:#bbf7d0;">
          ${status.toUpperCase()}
        </div>
      </div>
      <div class="meta">Scheduled: ${new Date(it.scheduledTime).toLocaleString()}</div>
      <div class="countdown" id="cd-dash-${it.id}">—</div>
      <div class="dash-controls">
        <button class="btn small ghost" onclick="openEdit(${it.id})">Edit</button>
        <button class="btn small danger" onclick="removeItem(${it.id})">Delete</button>
        <button class="btn small" onclick="pauseAudio(${it.id})">Pause</button>
        <button class="btn small secondary" onclick="resumeAudio(${it.id})">Resume</button>
        <button class="btn small danger" onclick="stopAudio(${it.id})">Stop</button>
      </div>
    `;
    dashboard.appendChild(card);
  });
}

/* ====================== COUNTDOWNS (Library + Dashboard) ====================== */
function tickCountdowns(){
  const now = Date.now();
  items.forEach(it=>{
    if(!it.scheduledTime) return;
    const tgt = new Date(it.scheduledTime).getTime();
    const diff = tgt - now;

    const fmt = ()=>{
      const s = Math.max(0, Math.floor(diff/1000));
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${h}h ${m}m ${ss}s`;
    };

    const libEl = document.getElementById('cd-lib-'+it.id);
    const dashEl = document.getElementById('cd-dash-'+it.id);

    if(diff>0){
      libEl && (libEl.textContent = `⏳ Starts in ${fmt()}`);
      dashEl && (dashEl.textContent = `⏳ Starts in ${fmt()}`);
    }else{
      if(activePlayers[it.id]){
        libEl && (libEl.textContent = '▶️ Playing now');
        dashEl && (dashEl.textContent = '▶️ Playing now');
      }else{
        libEl && (libEl.textContent = it.played ? '✅ Finished' : '⏰ Pending trigger…');
        dashEl && (dashEl.textContent = it.played ? '✅ Finished' : '⏰ Pending trigger…');
      }
    }
  });
}
setInterval(tickCountdowns, 1000);

/* ====================== PLAYBACK ENGINE ====================== */
const channel = new BroadcastChannel('audiva_channel');

function playAudio(it){
  if(activePlayers[it.id] || it.played) return;
  const url = URL.createObjectURL(it.blob);
  const audio = new Audio(url);
  activePlayers[it.id] = audio;

  audio.play().then(()=>{
    it.played = true; saveItem(it);
    postStatus(it,'playing');
    renderDashboard(); tickCountdowns(); // refresh status card
    toast(`Playing: ${it.fileName}`);
  }).catch(err=>{ console.error(err); toast('Playback blocked — user gesture may be required'); });

  audio.onended = ()=>{
    postStatus(it,'ended');
    delete activePlayers[it.id];
    renderDashboard(); tickCountdowns();
  };
}

function pauseAudio(id){
  const a = activePlayers[id]; if(!a) return;
  a.pause(); postStatus({id, ...findItem(id)}, 'paused');
}
function resumeAudio(id){
  const a = activePlayers[id]; if(!a) return;
  a.play(); postStatus({id, ...findItem(id)}, 'playing');
}
function stopAudio(id){
  const a = activePlayers[id]; if(!a) return;
  a.pause(); a.currentTime=0; delete activePlayers[id];
  postStatus({id, ...findItem(id)}, 'stopped');
  renderDashboard(); tickCountdowns();
}

function findItem(id){ return items.find(x=>x.id===id) || {}; }

/* Trigger loop — fire once when time reached */
setInterval(()=>{
  const now = Date.now();
  items.forEach(it=>{
    if(it.scheduledTime && !it.played && !activePlayers[it.id]){
      const tgt = new Date(it.scheduledTime).getTime();
      if(now >= tgt && now - tgt < 1500){ // fire within 1.5s window
        playAudio(it);
      }
    }
  });
}, 500);

/* ====================== AGI VIEW ====================== */
function openAGI(){ window.open('playing.html','_blank'); }
function postStatus(it,status){
  const payload = {
    type:'status_update',
    status,
    id: it.id,
    fileName: it.fileName,
    group: it.group,
    scheduledTime: it.scheduledTime
  };
  channel.postMessage(payload);
}

/* ====================== TOAST ====================== */
const toastEl = document.getElementById('toast');
let toastTimer;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 2500);
}
</script>
</body>
</html>
